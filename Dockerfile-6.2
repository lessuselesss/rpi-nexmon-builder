FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update
RUN apt-get -y install git bc bison flex libssl-dev make libc6-dev libncurses5-dev crossbuild-essential-arm64

WORKDIR /code
RUN git clone --depth=1 -b ubuntu/lunar-updates https://git.launchpad.net/ubuntu/+source/linux-raspi

WORKDIR /code/linux-raspi
COPY nexmon.6.2.patch /code/
RUN git apply /code/nexmon.6.2.patch
ENV KERNEL=kernel8
# make config
RUN make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- bcm2711_defconfig 

# build 
RUN make -j `nproc` ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules

# Build the nexmon module
RUN make -j `nproc` ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- M=drivers/net/wireless/broadcom/brcm80211/brcmfmac
